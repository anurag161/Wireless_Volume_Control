<html>
<head>
<title>test_bsd.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_bsd.py</font>
</center></td></tr></table>
<pre><span class="s0">#!/usr/bin/env python3</span>

<span class="s0"># Copyright (c) 2009, Giampaolo Rodola'. All rights reserved.</span>
<span class="s0"># Use of this source code is governed by a BSD-style license that can be</span>
<span class="s0"># found in the LICENSE file.</span>

<span class="s0"># TODO: (FreeBSD) add test for comparing connections with 'sockstat' cmd.</span>


<span class="s2">&quot;&quot;&quot;Tests specific to all BSD platforms.&quot;&quot;&quot;</span>


<span class="s3">import </span><span class="s1">datetime</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">re</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">import </span><span class="s1">unittest</span>

<span class="s3">import </span><span class="s1">psutil</span>
<span class="s3">from </span><span class="s1">psutil </span><span class="s3">import </span><span class="s1">BSD</span>
<span class="s3">from </span><span class="s1">psutil </span><span class="s3">import </span><span class="s1">FREEBSD</span>
<span class="s3">from </span><span class="s1">psutil </span><span class="s3">import </span><span class="s1">NETBSD</span>
<span class="s3">from </span><span class="s1">psutil </span><span class="s3">import </span><span class="s1">OPENBSD</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">HAS_BATTERY</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">TOLERANCE_SYS_MEM</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">PsutilTestCase</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">retry_on_failure</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">sh</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">spawn_testproc</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">terminate</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">which</span>


<span class="s3">if </span><span class="s1">BSD:</span>
    <span class="s3">from </span><span class="s1">psutil._psutil_posix </span><span class="s3">import </span><span class="s1">getpagesize</span>

    <span class="s1">PAGESIZE = getpagesize()</span>
    <span class="s0"># muse requires root privileges</span>
    <span class="s1">MUSE_AVAILABLE = </span><span class="s3">True if </span><span class="s1">os.getuid() == </span><span class="s4">0 </span><span class="s3">and </span><span class="s1">which(</span><span class="s5">'muse'</span><span class="s1">) </span><span class="s3">else False</span>
<span class="s3">else</span><span class="s1">:</span>
    <span class="s1">PAGESIZE = </span><span class="s3">None</span>
    <span class="s1">MUSE_AVAILABLE = </span><span class="s3">False</span>


<span class="s3">def </span><span class="s1">sysctl(cmdline):</span>
    <span class="s2">&quot;&quot;&quot;Expects a sysctl command with an argument and parse the result 
    returning only the value of interest. 
    &quot;&quot;&quot;</span>
    <span class="s1">result = sh(</span><span class="s5">&quot;sysctl &quot; </span><span class="s1">+ cmdline)</span>
    <span class="s3">if </span><span class="s1">FREEBSD:</span>
        <span class="s1">result = result[result.find(</span><span class="s5">&quot;: &quot;</span><span class="s1">) + </span><span class="s4">2</span><span class="s1">:]</span>
    <span class="s3">elif </span><span class="s1">OPENBSD </span><span class="s3">or </span><span class="s1">NETBSD:</span>
        <span class="s1">result = result[result.find(</span><span class="s5">&quot;=&quot;</span><span class="s1">) + </span><span class="s4">1</span><span class="s1">:]</span>
    <span class="s3">try</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s1">int(result)</span>
    <span class="s3">except </span><span class="s1">ValueError:</span>
        <span class="s3">return </span><span class="s1">result</span>


<span class="s3">def </span><span class="s1">muse(field):</span>
    <span class="s2">&quot;&quot;&quot;Thin wrapper around 'muse' cmdline utility.&quot;&quot;&quot;</span>
    <span class="s1">out = sh(</span><span class="s5">'muse'</span><span class="s1">)</span>
    <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">):</span>
        <span class="s3">if </span><span class="s1">line.startswith(field):</span>
            <span class="s3">break</span>
    <span class="s3">else</span><span class="s1">:</span>
        <span class="s3">raise </span><span class="s1">ValueError(</span><span class="s5">&quot;line not found&quot;</span><span class="s1">)</span>
    <span class="s3">return </span><span class="s1">int(line.split()[</span><span class="s4">1</span><span class="s1">])</span>


<span class="s0"># =====================================================================</span>
<span class="s0"># --- All BSD*</span>
<span class="s0"># =====================================================================</span>


<span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">BSD</span><span class="s3">, </span><span class="s5">&quot;BSD only&quot;</span><span class="s1">)</span>
<span class="s3">class </span><span class="s1">BSDTestCase(PsutilTestCase):</span>
    <span class="s2">&quot;&quot;&quot;Generic tests common to all BSD variants.&quot;&quot;&quot;</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setUpClass(cls):</span>
        <span class="s1">cls.pid = spawn_testproc().pid</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">tearDownClass(cls):</span>
        <span class="s1">terminate(cls.pid)</span>

    <span class="s1">@unittest.skipIf(NETBSD</span><span class="s3">, </span><span class="s5">&quot;-o lstart doesn't work on NETBSD&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_process_create_time(self):</span>
        <span class="s1">output = sh(</span><span class="s5">&quot;ps -o lstart -p %s&quot; </span><span class="s1">% self.pid)</span>
        <span class="s1">start_ps = output.replace(</span><span class="s5">'STARTED'</span><span class="s3">, </span><span class="s5">''</span><span class="s1">).strip()</span>
        <span class="s1">start_psutil = psutil.Process(self.pid).create_time()</span>
        <span class="s1">start_psutil = time.strftime(</span><span class="s5">&quot;%a %b %e %H:%M:%S %Y&quot;</span><span class="s3">,</span>
                                     <span class="s1">time.localtime(start_psutil))</span>
        <span class="s1">self.assertEqual(start_ps</span><span class="s3">, </span><span class="s1">start_psutil)</span>

    <span class="s3">def </span><span class="s1">test_disks(self):</span>
        <span class="s0"># test psutil.disk_usage() and psutil.disk_partitions()</span>
        <span class="s0"># against &quot;df -a&quot;</span>
        <span class="s3">def </span><span class="s1">df(path):</span>
            <span class="s1">out = sh(</span><span class="s5">'df -k &quot;%s&quot;' </span><span class="s1">% path).strip()</span>
            <span class="s1">lines = out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">)</span>
            <span class="s1">lines.pop(</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">line = lines.pop(</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">dev</span><span class="s3">, </span><span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free = line.split()[:</span><span class="s4">4</span><span class="s1">]</span>
            <span class="s3">if </span><span class="s1">dev == </span><span class="s5">'none'</span><span class="s1">:</span>
                <span class="s1">dev = </span><span class="s5">''</span>
            <span class="s1">total = int(total) * </span><span class="s4">1024</span>
            <span class="s1">used = int(used) * </span><span class="s4">1024</span>
            <span class="s1">free = int(free) * </span><span class="s4">1024</span>
            <span class="s3">return </span><span class="s1">dev</span><span class="s3">, </span><span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free</span>

        <span class="s3">for </span><span class="s1">part </span><span class="s3">in </span><span class="s1">psutil.disk_partitions(all=</span><span class="s3">False</span><span class="s1">):</span>
            <span class="s1">usage = psutil.disk_usage(part.mountpoint)</span>
            <span class="s1">dev</span><span class="s3">, </span><span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free = df(part.mountpoint)</span>
            <span class="s1">self.assertEqual(part.device</span><span class="s3">, </span><span class="s1">dev)</span>
            <span class="s1">self.assertEqual(usage.total</span><span class="s3">, </span><span class="s1">total)</span>
            <span class="s0"># 10 MB tolerance</span>
            <span class="s3">if </span><span class="s1">abs(usage.free - free) &gt; </span><span class="s4">10 </span><span class="s1">* </span><span class="s4">1024 </span><span class="s1">* </span><span class="s4">1024</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">self.fail(</span><span class="s5">&quot;psutil=%s, df=%s&quot; </span><span class="s1">% (usage.free</span><span class="s3">, </span><span class="s1">free))</span>
            <span class="s3">if </span><span class="s1">abs(usage.used - used) &gt; </span><span class="s4">10 </span><span class="s1">* </span><span class="s4">1024 </span><span class="s1">* </span><span class="s4">1024</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">self.fail(</span><span class="s5">&quot;psutil=%s, df=%s&quot; </span><span class="s1">% (usage.used</span><span class="s3">, </span><span class="s1">used))</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">which(</span><span class="s5">'sysctl'</span><span class="s1">)</span><span class="s3">, </span><span class="s5">&quot;sysctl cmd not available&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_cpu_count_logical(self):</span>
        <span class="s1">syst = sysctl(</span><span class="s5">&quot;hw.ncpu&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(psutil.cpu_count(logical=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">, </span><span class="s1">syst)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">which(</span><span class="s5">'sysctl'</span><span class="s1">)</span><span class="s3">, </span><span class="s5">&quot;sysctl cmd not available&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_virtual_memory_total(self):</span>
        <span class="s1">num = sysctl(</span><span class="s5">'hw.physmem'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(num</span><span class="s3">, </span><span class="s1">psutil.virtual_memory().total)</span>

    <span class="s3">def </span><span class="s1">test_net_if_stats(self):</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">stats </span><span class="s3">in </span><span class="s1">psutil.net_if_stats().items():</span>
            <span class="s3">try</span><span class="s1">:</span>
                <span class="s1">out = sh(</span><span class="s5">&quot;ifconfig %s&quot; </span><span class="s1">% name)</span>
            <span class="s3">except </span><span class="s1">RuntimeError:</span>
                <span class="s3">pass</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">self.assertEqual(stats.isup</span><span class="s3">, </span><span class="s5">'RUNNING' </span><span class="s3">in </span><span class="s1">out</span><span class="s3">, </span><span class="s1">msg=out)</span>
                <span class="s3">if </span><span class="s5">&quot;mtu&quot; </span><span class="s3">in </span><span class="s1">out:</span>
                    <span class="s1">self.assertEqual(stats.mtu</span><span class="s3">,</span>
                                     <span class="s1">int(re.findall(</span><span class="s5">r'mtu (\d+)'</span><span class="s3">, </span><span class="s1">out)[</span><span class="s4">0</span><span class="s1">]))</span>


<span class="s0"># =====================================================================</span>
<span class="s0"># --- FreeBSD</span>
<span class="s0"># =====================================================================</span>


<span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">FREEBSD</span><span class="s3">, </span><span class="s5">&quot;FREEBSD only&quot;</span><span class="s1">)</span>
<span class="s3">class </span><span class="s1">FreeBSDPsutilTestCase(PsutilTestCase):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setUpClass(cls):</span>
        <span class="s1">cls.pid = spawn_testproc().pid</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">tearDownClass(cls):</span>
        <span class="s1">terminate(cls.pid)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_memory_maps(self):</span>
        <span class="s1">out = sh(</span><span class="s5">'procstat -v %s' </span><span class="s1">% self.pid)</span>
        <span class="s1">maps = psutil.Process(self.pid).memory_maps(grouped=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">lines = out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">)[</span><span class="s4">1</span><span class="s1">:]</span>
        <span class="s3">while </span><span class="s1">lines:</span>
            <span class="s1">line = lines.pop()</span>
            <span class="s1">fields = line.split()</span>
            <span class="s1">_</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">, </span><span class="s1">perms</span><span class="s3">, </span><span class="s1">res = fields[:</span><span class="s4">5</span><span class="s1">]</span>
            <span class="s1">map = maps.pop()</span>
            <span class="s1">self.assertEqual(</span><span class="s5">&quot;%s-%s&quot; </span><span class="s1">% (start</span><span class="s3">, </span><span class="s1">stop)</span><span class="s3">, </span><span class="s1">map.addr)</span>
            <span class="s1">self.assertEqual(int(res)</span><span class="s3">, </span><span class="s1">map.rss)</span>
            <span class="s3">if not </span><span class="s1">map.path.startswith(</span><span class="s5">'['</span><span class="s1">):</span>
                <span class="s1">self.assertEqual(fields[</span><span class="s4">10</span><span class="s1">]</span><span class="s3">, </span><span class="s1">map.path)</span>

    <span class="s3">def </span><span class="s1">test_exe(self):</span>
        <span class="s1">out = sh(</span><span class="s5">'procstat -b %s' </span><span class="s1">% self.pid)</span>
        <span class="s1">self.assertEqual(psutil.Process(self.pid).exe()</span><span class="s3">,</span>
                         <span class="s1">out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">)[</span><span class="s4">1</span><span class="s1">].split()[-</span><span class="s4">1</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_cmdline(self):</span>
        <span class="s1">out = sh(</span><span class="s5">'procstat -c %s' </span><span class="s1">% self.pid)</span>
        <span class="s1">self.assertEqual(</span><span class="s5">' '</span><span class="s1">.join(psutil.Process(self.pid).cmdline())</span><span class="s3">,</span>
                         <span class="s5">' '</span><span class="s1">.join(out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">)[</span><span class="s4">1</span><span class="s1">].split()[</span><span class="s4">2</span><span class="s1">:]))</span>

    <span class="s3">def </span><span class="s1">test_uids_gids(self):</span>
        <span class="s1">out = sh(</span><span class="s5">'procstat -s %s' </span><span class="s1">% self.pid)</span>
        <span class="s1">euid</span><span class="s3">, </span><span class="s1">ruid</span><span class="s3">, </span><span class="s1">suid</span><span class="s3">, </span><span class="s1">egid</span><span class="s3">, </span><span class="s1">rgid</span><span class="s3">, </span><span class="s1">sgid = out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">)[</span><span class="s4">1</span><span class="s1">].split()[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">8</span><span class="s1">]</span>
        <span class="s1">p = psutil.Process(self.pid)</span>
        <span class="s1">uids = p.uids()</span>
        <span class="s1">gids = p.gids()</span>
        <span class="s1">self.assertEqual(uids.real</span><span class="s3">, </span><span class="s1">int(ruid))</span>
        <span class="s1">self.assertEqual(uids.effective</span><span class="s3">, </span><span class="s1">int(euid))</span>
        <span class="s1">self.assertEqual(uids.saved</span><span class="s3">, </span><span class="s1">int(suid))</span>
        <span class="s1">self.assertEqual(gids.real</span><span class="s3">, </span><span class="s1">int(rgid))</span>
        <span class="s1">self.assertEqual(gids.effective</span><span class="s3">, </span><span class="s1">int(egid))</span>
        <span class="s1">self.assertEqual(gids.saved</span><span class="s3">, </span><span class="s1">int(sgid))</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_ctx_switches(self):</span>
        <span class="s1">tested = []</span>
        <span class="s1">out = sh(</span><span class="s5">'procstat -r %s' </span><span class="s1">% self.pid)</span>
        <span class="s1">p = psutil.Process(self.pid)</span>
        <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">):</span>
            <span class="s1">line = line.lower().strip()</span>
            <span class="s3">if </span><span class="s5">' voluntary context' </span><span class="s3">in </span><span class="s1">line:</span>
                <span class="s1">pstat_value = int(line.split()[-</span><span class="s4">1</span><span class="s1">])</span>
                <span class="s1">psutil_value = p.num_ctx_switches().voluntary</span>
                <span class="s1">self.assertEqual(pstat_value</span><span class="s3">, </span><span class="s1">psutil_value)</span>
                <span class="s1">tested.append(</span><span class="s3">None</span><span class="s1">)</span>
            <span class="s3">elif </span><span class="s5">' involuntary context' </span><span class="s3">in </span><span class="s1">line:</span>
                <span class="s1">pstat_value = int(line.split()[-</span><span class="s4">1</span><span class="s1">])</span>
                <span class="s1">psutil_value = p.num_ctx_switches().involuntary</span>
                <span class="s1">self.assertEqual(pstat_value</span><span class="s3">, </span><span class="s1">psutil_value)</span>
                <span class="s1">tested.append(</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">len(tested) != </span><span class="s4">2</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">RuntimeError(</span><span class="s5">&quot;couldn't find lines match in procstat out&quot;</span><span class="s1">)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_cpu_times(self):</span>
        <span class="s1">tested = []</span>
        <span class="s1">out = sh(</span><span class="s5">'procstat -r %s' </span><span class="s1">% self.pid)</span>
        <span class="s1">p = psutil.Process(self.pid)</span>
        <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">out.split(</span><span class="s5">'</span><span class="s3">\n</span><span class="s5">'</span><span class="s1">):</span>
            <span class="s1">line = line.lower().strip()</span>
            <span class="s3">if </span><span class="s5">'user time' </span><span class="s3">in </span><span class="s1">line:</span>
                <span class="s1">pstat_value = float(</span><span class="s5">'0.' </span><span class="s1">+ line.split()[-</span><span class="s4">1</span><span class="s1">].split(</span><span class="s5">'.'</span><span class="s1">)[-</span><span class="s4">1</span><span class="s1">])</span>
                <span class="s1">psutil_value = p.cpu_times().user</span>
                <span class="s1">self.assertEqual(pstat_value</span><span class="s3">, </span><span class="s1">psutil_value)</span>
                <span class="s1">tested.append(</span><span class="s3">None</span><span class="s1">)</span>
            <span class="s3">elif </span><span class="s5">'system time' </span><span class="s3">in </span><span class="s1">line:</span>
                <span class="s1">pstat_value = float(</span><span class="s5">'0.' </span><span class="s1">+ line.split()[-</span><span class="s4">1</span><span class="s1">].split(</span><span class="s5">'.'</span><span class="s1">)[-</span><span class="s4">1</span><span class="s1">])</span>
                <span class="s1">psutil_value = p.cpu_times().system</span>
                <span class="s1">self.assertEqual(pstat_value</span><span class="s3">, </span><span class="s1">psutil_value)</span>
                <span class="s1">tested.append(</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">len(tested) != </span><span class="s4">2</span><span class="s1">:</span>
            <span class="s3">raise </span><span class="s1">RuntimeError(</span><span class="s5">&quot;couldn't find lines match in procstat out&quot;</span><span class="s1">)</span>


<span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">FREEBSD</span><span class="s3">, </span><span class="s5">&quot;FREEBSD only&quot;</span><span class="s1">)</span>
<span class="s3">class </span><span class="s1">FreeBSDSystemTestCase(PsutilTestCase):</span>

    <span class="s1">@staticmethod</span>
    <span class="s3">def </span><span class="s1">parse_swapinfo():</span>
        <span class="s0"># the last line is always the total</span>
        <span class="s1">output = sh(</span><span class="s5">&quot;swapinfo -k&quot;</span><span class="s1">).splitlines()[-</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">parts = re.split(</span><span class="s5">r'\s+'</span><span class="s3">, </span><span class="s1">output)</span>

        <span class="s3">if not </span><span class="s1">parts:</span>
            <span class="s3">raise </span><span class="s1">ValueError(</span><span class="s5">&quot;Can't parse swapinfo: %s&quot; </span><span class="s1">% output)</span>

        <span class="s0"># the size is in 1k units, so multiply by 1024</span>
        <span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free = (int(p) * </span><span class="s4">1024 </span><span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s1">parts[</span><span class="s4">1</span><span class="s1">:</span><span class="s4">4</span><span class="s1">])</span>
        <span class="s3">return </span><span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free</span>

    <span class="s3">def </span><span class="s1">test_cpu_frequency_against_sysctl(self):</span>
        <span class="s0"># Currently only cpu 0 is frequency is supported in FreeBSD</span>
        <span class="s0"># All other cores use the same frequency.</span>
        <span class="s1">sensor = </span><span class="s5">&quot;dev.cpu.0.freq&quot;</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s1">sysctl_result = int(sysctl(sensor))</span>
        <span class="s3">except </span><span class="s1">RuntimeError:</span>
            <span class="s1">self.skipTest(</span><span class="s5">&quot;frequencies not supported by kernel&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(psutil.cpu_freq().current</span><span class="s3">, </span><span class="s1">sysctl_result)</span>

        <span class="s1">sensor = </span><span class="s5">&quot;dev.cpu.0.freq_levels&quot;</span>
        <span class="s1">sysctl_result = sysctl(sensor)</span>
        <span class="s0"># sysctl returns a string of the format:</span>
        <span class="s0"># &lt;freq_level_1&gt;/&lt;voltage_level_1&gt; &lt;freq_level_2&gt;/&lt;voltage_level_2&gt;...</span>
        <span class="s0"># Ordered highest available to lowest available.</span>
        <span class="s1">max_freq = int(sysctl_result.split()[</span><span class="s4">0</span><span class="s1">].split(</span><span class="s5">&quot;/&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">min_freq = int(sysctl_result.split()[-</span><span class="s4">1</span><span class="s1">].split(</span><span class="s5">&quot;/&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">self.assertEqual(psutil.cpu_freq().max</span><span class="s3">, </span><span class="s1">max_freq)</span>
        <span class="s1">self.assertEqual(psutil.cpu_freq().min</span><span class="s3">, </span><span class="s1">min_freq)</span>

    <span class="s0"># --- virtual_memory(); tests against sysctl</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_vmem_active(self):</span>
        <span class="s1">syst = sysctl(</span><span class="s5">&quot;vm.stats.vm.v_active_count&quot;</span><span class="s1">) * PAGESIZE</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().active</span><span class="s3">, </span><span class="s1">syst</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_vmem_inactive(self):</span>
        <span class="s1">syst = sysctl(</span><span class="s5">&quot;vm.stats.vm.v_inactive_count&quot;</span><span class="s1">) * PAGESIZE</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().inactive</span><span class="s3">, </span><span class="s1">syst</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_vmem_wired(self):</span>
        <span class="s1">syst = sysctl(</span><span class="s5">&quot;vm.stats.vm.v_wire_count&quot;</span><span class="s1">) * PAGESIZE</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().wired</span><span class="s3">, </span><span class="s1">syst</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_vmem_cached(self):</span>
        <span class="s1">syst = sysctl(</span><span class="s5">&quot;vm.stats.vm.v_cache_count&quot;</span><span class="s1">) * PAGESIZE</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().cached</span><span class="s3">, </span><span class="s1">syst</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_vmem_free(self):</span>
        <span class="s1">syst = sysctl(</span><span class="s5">&quot;vm.stats.vm.v_free_count&quot;</span><span class="s1">) * PAGESIZE</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().free</span><span class="s3">, </span><span class="s1">syst</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_vmem_buffers(self):</span>
        <span class="s1">syst = sysctl(</span><span class="s5">&quot;vfs.bufspace&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().buffers</span><span class="s3">, </span><span class="s1">syst</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s0"># --- virtual_memory(); tests against muse</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">MUSE_AVAILABLE</span><span class="s3">, </span><span class="s5">&quot;muse not installed&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_muse_vmem_total(self):</span>
        <span class="s1">num = muse(</span><span class="s5">'Total'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(psutil.virtual_memory().total</span><span class="s3">, </span><span class="s1">num)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">MUSE_AVAILABLE</span><span class="s3">, </span><span class="s5">&quot;muse not installed&quot;</span><span class="s1">)</span>
    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_muse_vmem_active(self):</span>
        <span class="s1">num = muse(</span><span class="s5">'Active'</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().active</span><span class="s3">, </span><span class="s1">num</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">MUSE_AVAILABLE</span><span class="s3">, </span><span class="s5">&quot;muse not installed&quot;</span><span class="s1">)</span>
    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_muse_vmem_inactive(self):</span>
        <span class="s1">num = muse(</span><span class="s5">'Inactive'</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().inactive</span><span class="s3">, </span><span class="s1">num</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">MUSE_AVAILABLE</span><span class="s3">, </span><span class="s5">&quot;muse not installed&quot;</span><span class="s1">)</span>
    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_muse_vmem_wired(self):</span>
        <span class="s1">num = muse(</span><span class="s5">'Wired'</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().wired</span><span class="s3">, </span><span class="s1">num</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">MUSE_AVAILABLE</span><span class="s3">, </span><span class="s5">&quot;muse not installed&quot;</span><span class="s1">)</span>
    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_muse_vmem_cached(self):</span>
        <span class="s1">num = muse(</span><span class="s5">'Cache'</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().cached</span><span class="s3">, </span><span class="s1">num</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">MUSE_AVAILABLE</span><span class="s3">, </span><span class="s5">&quot;muse not installed&quot;</span><span class="s1">)</span>
    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_muse_vmem_free(self):</span>
        <span class="s1">num = muse(</span><span class="s5">'Free'</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().free</span><span class="s3">, </span><span class="s1">num</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">MUSE_AVAILABLE</span><span class="s3">, </span><span class="s5">&quot;muse not installed&quot;</span><span class="s1">)</span>
    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_muse_vmem_buffers(self):</span>
        <span class="s1">num = muse(</span><span class="s5">'Buffer'</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(psutil.virtual_memory().buffers</span><span class="s3">, </span><span class="s1">num</span><span class="s3">,</span>
                               <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_cpu_stats_ctx_switches(self):</span>
        <span class="s1">self.assertAlmostEqual(psutil.cpu_stats().ctx_switches</span><span class="s3">,</span>
                               <span class="s1">sysctl(</span><span class="s5">'vm.stats.sys.v_swtch'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">delta=</span><span class="s4">1000</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_cpu_stats_interrupts(self):</span>
        <span class="s1">self.assertAlmostEqual(psutil.cpu_stats().interrupts</span><span class="s3">,</span>
                               <span class="s1">sysctl(</span><span class="s5">'vm.stats.sys.v_intr'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">delta=</span><span class="s4">1000</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_cpu_stats_soft_interrupts(self):</span>
        <span class="s1">self.assertAlmostEqual(psutil.cpu_stats().soft_interrupts</span><span class="s3">,</span>
                               <span class="s1">sysctl(</span><span class="s5">'vm.stats.sys.v_soft'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">delta=</span><span class="s4">1000</span><span class="s1">)</span>

    <span class="s1">@retry_on_failure()</span>
    <span class="s3">def </span><span class="s1">test_cpu_stats_syscalls(self):</span>
        <span class="s0"># pretty high tolerance but it looks like it's OK.</span>
        <span class="s1">self.assertAlmostEqual(psutil.cpu_stats().syscalls</span><span class="s3">,</span>
                               <span class="s1">sysctl(</span><span class="s5">'vm.stats.sys.v_syscall'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">delta=</span><span class="s4">200000</span><span class="s1">)</span>

    <span class="s0"># def test_cpu_stats_traps(self):</span>
    <span class="s0">#    self.assertAlmostEqual(psutil.cpu_stats().traps,</span>
    <span class="s0">#                           sysctl('vm.stats.sys.v_trap'), delta=1000)</span>

    <span class="s0"># --- swap memory</span>

    <span class="s3">def </span><span class="s1">test_swapmem_free(self):</span>
        <span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free = self.parse_swapinfo()</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.swap_memory().free</span><span class="s3">, </span><span class="s1">free</span><span class="s3">, </span><span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_swapmem_used(self):</span>
        <span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free = self.parse_swapinfo()</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.swap_memory().used</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_swapmem_total(self):</span>
        <span class="s1">total</span><span class="s3">, </span><span class="s1">used</span><span class="s3">, </span><span class="s1">free = self.parse_swapinfo()</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.swap_memory().total</span><span class="s3">, </span><span class="s1">total</span><span class="s3">, </span><span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s0"># --- others</span>

    <span class="s3">def </span><span class="s1">test_boot_time(self):</span>
        <span class="s1">s = sysctl(</span><span class="s5">'sysctl kern.boottime'</span><span class="s1">)</span>
        <span class="s1">s = s[s.find(</span><span class="s5">&quot; sec = &quot;</span><span class="s1">) + </span><span class="s4">7</span><span class="s1">:]</span>
        <span class="s1">s = s[:s.find(</span><span class="s5">','</span><span class="s1">)]</span>
        <span class="s1">btime = int(s)</span>
        <span class="s1">self.assertEqual(btime</span><span class="s3">, </span><span class="s1">psutil.boot_time())</span>

    <span class="s0"># --- sensors_battery</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_BATTERY</span><span class="s3">, </span><span class="s5">&quot;no battery&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_sensors_battery(self):</span>
        <span class="s3">def </span><span class="s1">secs2hours(secs):</span>
            <span class="s1">m</span><span class="s3">, </span><span class="s1">s = divmod(secs</span><span class="s3">, </span><span class="s4">60</span><span class="s1">)</span>
            <span class="s1">h</span><span class="s3">, </span><span class="s1">m = divmod(m</span><span class="s3">, </span><span class="s4">60</span><span class="s1">)</span>
            <span class="s3">return </span><span class="s5">&quot;%d:%02d&quot; </span><span class="s1">% (h</span><span class="s3">, </span><span class="s1">m)</span>

        <span class="s1">out = sh(</span><span class="s5">&quot;acpiconf -i 0&quot;</span><span class="s1">)</span>
        <span class="s1">fields = dict([(x.split(</span><span class="s5">'</span><span class="s3">\t</span><span class="s5">'</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">x.split(</span><span class="s5">'</span><span class="s3">\t</span><span class="s5">'</span><span class="s1">)[-</span><span class="s4">1</span><span class="s1">])</span>
                       <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">out.split(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s1">)])</span>
        <span class="s1">metrics = psutil.sensors_battery()</span>
        <span class="s1">percent = int(fields[</span><span class="s5">'Remaining capacity:'</span><span class="s1">].replace(</span><span class="s5">'%'</span><span class="s3">, </span><span class="s5">''</span><span class="s1">))</span>
        <span class="s1">remaining_time = fields[</span><span class="s5">'Remaining time:'</span><span class="s1">]</span>
        <span class="s1">self.assertEqual(metrics.percent</span><span class="s3">, </span><span class="s1">percent)</span>
        <span class="s3">if </span><span class="s1">remaining_time == </span><span class="s5">'unknown'</span><span class="s1">:</span>
            <span class="s1">self.assertEqual(metrics.secsleft</span><span class="s3">, </span><span class="s1">psutil.POWER_TIME_UNLIMITED)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">self.assertEqual(secs2hours(metrics.secsleft)</span><span class="s3">, </span><span class="s1">remaining_time)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_BATTERY</span><span class="s3">, </span><span class="s5">&quot;no battery&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_sensors_battery_against_sysctl(self):</span>
        <span class="s1">self.assertEqual(psutil.sensors_battery().percent</span><span class="s3">,</span>
                         <span class="s1">sysctl(</span><span class="s5">&quot;hw.acpi.battery.life&quot;</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(psutil.sensors_battery().power_plugged</span><span class="s3">,</span>
                         <span class="s1">sysctl(</span><span class="s5">&quot;hw.acpi.acline&quot;</span><span class="s1">) == </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">secsleft = psutil.sensors_battery().secsleft</span>
        <span class="s3">if </span><span class="s1">secsleft &lt; </span><span class="s4">0</span><span class="s1">:</span>
            <span class="s1">self.assertEqual(sysctl(</span><span class="s5">&quot;hw.acpi.battery.time&quot;</span><span class="s1">)</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">self.assertEqual(secsleft</span><span class="s3">, </span><span class="s1">sysctl(</span><span class="s5">&quot;hw.acpi.battery.time&quot;</span><span class="s1">) * </span><span class="s4">60</span><span class="s1">)</span>

    <span class="s1">@unittest.skipIf(HAS_BATTERY</span><span class="s3">, </span><span class="s5">&quot;has battery&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_sensors_battery_no_battery(self):</span>
        <span class="s0"># If no battery is present one of these calls is supposed</span>
        <span class="s0"># to fail, see:</span>
        <span class="s0"># https://github.com/giampaolo/psutil/issues/1074</span>
        <span class="s3">with </span><span class="s1">self.assertRaises(RuntimeError):</span>
            <span class="s1">sysctl(</span><span class="s5">&quot;hw.acpi.battery.life&quot;</span><span class="s1">)</span>
            <span class="s1">sysctl(</span><span class="s5">&quot;hw.acpi.battery.time&quot;</span><span class="s1">)</span>
            <span class="s1">sysctl(</span><span class="s5">&quot;hw.acpi.acline&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertIsNone(psutil.sensors_battery())</span>

    <span class="s0"># --- sensors_temperatures</span>

    <span class="s3">def </span><span class="s1">test_sensors_temperatures_against_sysctl(self):</span>
        <span class="s1">num_cpus = psutil.cpu_count(</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">cpu </span><span class="s3">in </span><span class="s1">range(num_cpus):</span>
            <span class="s1">sensor = </span><span class="s5">&quot;dev.cpu.%s.temperature&quot; </span><span class="s1">% cpu</span>
            <span class="s0"># sysctl returns a string in the format 46.0C</span>
            <span class="s3">try</span><span class="s1">:</span>
                <span class="s1">sysctl_result = int(float(sysctl(sensor)[:-</span><span class="s4">1</span><span class="s1">]))</span>
            <span class="s3">except </span><span class="s1">RuntimeError:</span>
                <span class="s1">self.skipTest(</span><span class="s5">&quot;temperatures not supported by kernel&quot;</span><span class="s1">)</span>
            <span class="s1">self.assertAlmostEqual(</span>
                <span class="s1">psutil.sensors_temperatures()[</span><span class="s5">&quot;coretemp&quot;</span><span class="s1">][cpu].current</span><span class="s3">,</span>
                <span class="s1">sysctl_result</span><span class="s3">, </span><span class="s1">delta=</span><span class="s4">10</span><span class="s1">)</span>

            <span class="s1">sensor = </span><span class="s5">&quot;dev.cpu.%s.coretemp.tjmax&quot; </span><span class="s1">% cpu</span>
            <span class="s1">sysctl_result = int(float(sysctl(sensor)[:-</span><span class="s4">1</span><span class="s1">]))</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">psutil.sensors_temperatures()[</span><span class="s5">&quot;coretemp&quot;</span><span class="s1">][cpu].high</span><span class="s3">,</span>
                <span class="s1">sysctl_result)</span>


<span class="s0"># =====================================================================</span>
<span class="s0"># --- OpenBSD</span>
<span class="s0"># =====================================================================</span>


<span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">OPENBSD</span><span class="s3">, </span><span class="s5">&quot;OPENBSD only&quot;</span><span class="s1">)</span>
<span class="s3">class </span><span class="s1">OpenBSDTestCase(PsutilTestCase):</span>

    <span class="s3">def </span><span class="s1">test_boot_time(self):</span>
        <span class="s1">s = sysctl(</span><span class="s5">'kern.boottime'</span><span class="s1">)</span>
        <span class="s1">sys_bt = datetime.datetime.strptime(s</span><span class="s3">, </span><span class="s5">&quot;%a %b %d %H:%M:%S %Y&quot;</span><span class="s1">)</span>
        <span class="s1">psutil_bt = datetime.datetime.fromtimestamp(psutil.boot_time())</span>
        <span class="s1">self.assertEqual(sys_bt</span><span class="s3">, </span><span class="s1">psutil_bt)</span>


<span class="s0"># =====================================================================</span>
<span class="s0"># --- NetBSD</span>
<span class="s0"># =====================================================================</span>


<span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">NETBSD</span><span class="s3">, </span><span class="s5">&quot;NETBSD only&quot;</span><span class="s1">)</span>
<span class="s3">class </span><span class="s1">NetBSDTestCase(PsutilTestCase):</span>

    <span class="s1">@staticmethod</span>
    <span class="s3">def </span><span class="s1">parse_meminfo(look_for):</span>
        <span class="s3">with </span><span class="s1">open(</span><span class="s5">'/proc/meminfo'</span><span class="s3">, </span><span class="s5">'rt'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">f:</span>
                <span class="s3">if </span><span class="s1">line.startswith(look_for):</span>
                    <span class="s3">return </span><span class="s1">int(line.split()[</span><span class="s4">1</span><span class="s1">]) * </span><span class="s4">1024</span>
        <span class="s3">raise </span><span class="s1">ValueError(</span><span class="s5">&quot;can't find %s&quot; </span><span class="s1">% look_for)</span>

    <span class="s3">def </span><span class="s1">test_vmem_total(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">psutil.virtual_memory().total</span><span class="s3">, </span><span class="s1">self.parse_meminfo(</span><span class="s5">&quot;MemTotal:&quot;</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_vmem_free(self):</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.virtual_memory().free</span><span class="s3">, </span><span class="s1">self.parse_meminfo(</span><span class="s5">&quot;MemFree:&quot;</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_vmem_buffers(self):</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.virtual_memory().buffers</span><span class="s3">, </span><span class="s1">self.parse_meminfo(</span><span class="s5">&quot;Buffers:&quot;</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_vmem_shared(self):</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.virtual_memory().shared</span><span class="s3">, </span><span class="s1">self.parse_meminfo(</span><span class="s5">&quot;MemShared:&quot;</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_swapmem_total(self):</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.swap_memory().total</span><span class="s3">, </span><span class="s1">self.parse_meminfo(</span><span class="s5">&quot;SwapTotal:&quot;</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_swapmem_free(self):</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.swap_memory().free</span><span class="s3">, </span><span class="s1">self.parse_meminfo(</span><span class="s5">&quot;SwapFree:&quot;</span><span class="s1">)</span><span class="s3">,</span>
            <span class="s1">delta=TOLERANCE_SYS_MEM)</span>

    <span class="s3">def </span><span class="s1">test_swapmem_used(self):</span>
        <span class="s1">smem = psutil.swap_memory()</span>
        <span class="s1">self.assertEqual(smem.used</span><span class="s3">, </span><span class="s1">smem.total - smem.free)</span>

    <span class="s3">def </span><span class="s1">test_cpu_stats_interrupts(self):</span>
        <span class="s3">with </span><span class="s1">open(</span><span class="s5">'/proc/stat'</span><span class="s3">, </span><span class="s5">'rb'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">f:</span>
                <span class="s3">if </span><span class="s1">line.startswith(</span><span class="s6">b'intr'</span><span class="s1">):</span>
                    <span class="s1">interrupts = int(line.split()[</span><span class="s4">1</span><span class="s1">])</span>
                    <span class="s3">break</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">ValueError(</span><span class="s5">&quot;couldn't find line&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.cpu_stats().interrupts</span><span class="s3">, </span><span class="s1">interrupts</span><span class="s3">, </span><span class="s1">delta=</span><span class="s4">1000</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_cpu_stats_ctx_switches(self):</span>
        <span class="s3">with </span><span class="s1">open(</span><span class="s5">'/proc/stat'</span><span class="s3">, </span><span class="s5">'rb'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s3">for </span><span class="s1">line </span><span class="s3">in </span><span class="s1">f:</span>
                <span class="s3">if </span><span class="s1">line.startswith(</span><span class="s6">b'ctxt'</span><span class="s1">):</span>
                    <span class="s1">ctx_switches = int(line.split()[</span><span class="s4">1</span><span class="s1">])</span>
                    <span class="s3">break</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s3">raise </span><span class="s1">ValueError(</span><span class="s5">&quot;couldn't find line&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertAlmostEqual(</span>
            <span class="s1">psutil.cpu_stats().ctx_switches</span><span class="s3">, </span><span class="s1">ctx_switches</span><span class="s3">, </span><span class="s1">delta=</span><span class="s4">1000</span><span class="s1">)</span>


<span class="s3">if </span><span class="s1">__name__ == </span><span class="s5">'__main__'</span><span class="s1">:</span>
    <span class="s3">from </span><span class="s1">psutil.tests.runner </span><span class="s3">import </span><span class="s1">run_from_name</span>
    <span class="s1">run_from_name(__file__)</span>
</pre>
</body>
</html>