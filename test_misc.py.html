<html>
<head>
<title>test_misc.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_misc.py</font>
</center></td></tr></table>
<pre><span class="s0">#!/usr/bin/env python3</span>
<span class="s0"># -*- coding: utf-8 -*-</span>

<span class="s0"># Copyright (c) 2009, Giampaolo Rodola'. All rights reserved.</span>
<span class="s0"># Use of this source code is governed by a BSD-style license that can be</span>
<span class="s0"># found in the LICENSE file.</span>

<span class="s2">&quot;&quot;&quot; 
Miscellaneous tests. 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">ast</span>
<span class="s3">import </span><span class="s1">collections</span>
<span class="s3">import </span><span class="s1">errno</span>
<span class="s3">import </span><span class="s1">json</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">pickle</span>
<span class="s3">import </span><span class="s1">socket</span>
<span class="s3">import </span><span class="s1">stat</span>
<span class="s3">import </span><span class="s1">unittest</span>

<span class="s3">import </span><span class="s1">psutil</span>
<span class="s3">import </span><span class="s1">psutil.tests</span>
<span class="s3">from </span><span class="s1">psutil </span><span class="s3">import </span><span class="s1">LINUX</span>
<span class="s3">from </span><span class="s1">psutil </span><span class="s3">import </span><span class="s1">POSIX</span>
<span class="s3">from </span><span class="s1">psutil </span><span class="s3">import </span><span class="s1">WINDOWS</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">bcat</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">cat</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">debug</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">isfile_strict</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">memoize</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">memoize_when_activated</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">parse_environ_block</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">supports_ipv6</span>
<span class="s3">from </span><span class="s1">psutil._common </span><span class="s3">import </span><span class="s1">wrap_numbers</span>
<span class="s3">from </span><span class="s1">psutil._compat </span><span class="s3">import </span><span class="s1">PY3</span>
<span class="s3">from </span><span class="s1">psutil._compat </span><span class="s3">import </span><span class="s1">FileNotFoundError</span>
<span class="s3">from </span><span class="s1">psutil._compat </span><span class="s3">import </span><span class="s1">redirect_stderr</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">APPVEYOR</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">CI_TESTING</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">HAS_BATTERY</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">HAS_MEMORY_MAPS</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">HAS_NET_IO_COUNTERS</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">HAS_SENSORS_BATTERY</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">HAS_SENSORS_FANS</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">HAS_SENSORS_TEMPERATURES</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">PYTHON_EXE</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">ROOT_DIR</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">SCRIPTS_DIR</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">PsutilTestCase</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">import_module_by_path</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">mock</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">reload_module</span>
<span class="s3">from </span><span class="s1">psutil.tests </span><span class="s3">import </span><span class="s1">sh</span>


<span class="s0"># ===================================================================</span>
<span class="s0"># --- Test classes' repr(), str(), ...</span>
<span class="s0"># ===================================================================</span>


<span class="s3">class </span><span class="s1">TestSpecialMethods(PsutilTestCase):</span>

    <span class="s3">def </span><span class="s1">test_process__repr__(self</span><span class="s3">, </span><span class="s1">func=repr):</span>
        <span class="s1">p = psutil.Process(self.spawn_testproc().pid)</span>
        <span class="s1">r = func(p)</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;psutil.Process&quot;</span><span class="s3">, </span><span class="s1">r)</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;pid=%s&quot; </span><span class="s1">% p.pid</span><span class="s3">, </span><span class="s1">r)</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;name='%s'&quot; </span><span class="s1">% str(p.name())</span><span class="s3">,</span>
                      <span class="s1">r.replace(</span><span class="s4">&quot;name=u'&quot;</span><span class="s3">, </span><span class="s4">&quot;name='&quot;</span><span class="s1">))</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;status=&quot;</span><span class="s3">, </span><span class="s1">r)</span>
        <span class="s1">self.assertNotIn(</span><span class="s4">&quot;exitcode=&quot;</span><span class="s3">, </span><span class="s1">r)</span>
        <span class="s1">p.terminate()</span>
        <span class="s1">p.wait()</span>
        <span class="s1">r = func(p)</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;status='terminated'&quot;</span><span class="s3">, </span><span class="s1">r)</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;exitcode=&quot;</span><span class="s3">, </span><span class="s1">r)</span>

        <span class="s3">with </span><span class="s1">mock.patch.object(psutil.Process</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">,</span>
                               <span class="s1">side_effect=psutil.ZombieProcess(os.getpid())):</span>
            <span class="s1">p = psutil.Process()</span>
            <span class="s1">r = func(p)</span>
            <span class="s1">self.assertIn(</span><span class="s4">&quot;pid=%s&quot; </span><span class="s1">% p.pid</span><span class="s3">, </span><span class="s1">r)</span>
            <span class="s1">self.assertIn(</span><span class="s4">&quot;status='zombie'&quot;</span><span class="s3">, </span><span class="s1">r)</span>
            <span class="s1">self.assertNotIn(</span><span class="s4">&quot;name=&quot;</span><span class="s3">, </span><span class="s1">r)</span>
        <span class="s3">with </span><span class="s1">mock.patch.object(psutil.Process</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">,</span>
                               <span class="s1">side_effect=psutil.NoSuchProcess(os.getpid())):</span>
            <span class="s1">p = psutil.Process()</span>
            <span class="s1">r = func(p)</span>
            <span class="s1">self.assertIn(</span><span class="s4">&quot;pid=%s&quot; </span><span class="s1">% p.pid</span><span class="s3">, </span><span class="s1">r)</span>
            <span class="s1">self.assertIn(</span><span class="s4">&quot;terminated&quot;</span><span class="s3">, </span><span class="s1">r)</span>
            <span class="s1">self.assertNotIn(</span><span class="s4">&quot;name=&quot;</span><span class="s3">, </span><span class="s1">r)</span>
        <span class="s3">with </span><span class="s1">mock.patch.object(psutil.Process</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">,</span>
                               <span class="s1">side_effect=psutil.AccessDenied(os.getpid())):</span>
            <span class="s1">p = psutil.Process()</span>
            <span class="s1">r = func(p)</span>
            <span class="s1">self.assertIn(</span><span class="s4">&quot;pid=%s&quot; </span><span class="s1">% p.pid</span><span class="s3">, </span><span class="s1">r)</span>
            <span class="s1">self.assertNotIn(</span><span class="s4">&quot;name=&quot;</span><span class="s3">, </span><span class="s1">r)</span>

    <span class="s3">def </span><span class="s1">test_process__str__(self):</span>
        <span class="s1">self.test_process__repr__(func=str)</span>

    <span class="s3">def </span><span class="s1">test_error__repr__(self):</span>
        <span class="s1">self.assertEqual(repr(psutil.Error())</span><span class="s3">, </span><span class="s4">&quot;psutil.Error()&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_error__str__(self):</span>
        <span class="s1">self.assertEqual(str(psutil.Error())</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_no_such_process__repr__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.NoSuchProcess(</span><span class="s5">321</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;psutil.NoSuchProcess(pid=321, msg='process no longer exists')&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.NoSuchProcess(</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">msg=</span><span class="s4">&quot;msg&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;psutil.NoSuchProcess(pid=321, name='name', msg='msg')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_no_such_process__str__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.NoSuchProcess(</span><span class="s5">321</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;process no longer exists (pid=321)&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.NoSuchProcess(</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">msg=</span><span class="s4">&quot;msg&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;msg (pid=321, name='name')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_zombie_process__repr__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.ZombieProcess(</span><span class="s5">321</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">'psutil.ZombieProcess(pid=321, msg=&quot;PID still '</span>
            <span class="s4">'exists but it</span><span class="s3">\'</span><span class="s4">s a zombie&quot;)'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.ZombieProcess(</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">ppid=</span><span class="s5">320</span><span class="s3">, </span><span class="s1">msg=</span><span class="s4">&quot;foo&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;psutil.ZombieProcess(pid=321, ppid=320, name='name', msg='foo')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_zombie_process__str__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.ZombieProcess(</span><span class="s5">321</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;PID still exists but it's a zombie (pid=321)&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.ZombieProcess(</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">ppid=</span><span class="s5">320</span><span class="s3">, </span><span class="s1">msg=</span><span class="s4">&quot;foo&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;foo (pid=321, ppid=320, name='name')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_access_denied__repr__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.AccessDenied(</span><span class="s5">321</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;psutil.AccessDenied(pid=321)&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.AccessDenied(</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">msg=</span><span class="s4">&quot;msg&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;psutil.AccessDenied(pid=321, name='name', msg='msg')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_access_denied__str__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.AccessDenied(</span><span class="s5">321</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;(pid=321)&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.AccessDenied(</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">msg=</span><span class="s4">&quot;msg&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;msg (pid=321, name='name')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_timeout_expired__repr__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.TimeoutExpired(</span><span class="s5">5</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;psutil.TimeoutExpired(seconds=5, msg='timeout after 5 seconds')&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">repr(psutil.TimeoutExpired(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">pid=</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;psutil.TimeoutExpired(pid=321, name='name', seconds=5, &quot;</span>
            <span class="s4">&quot;msg='timeout after 5 seconds')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_timeout_expired__str__(self):</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.TimeoutExpired(</span><span class="s5">5</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;timeout after 5 seconds&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">str(psutil.TimeoutExpired(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">pid=</span><span class="s5">321</span><span class="s3">, </span><span class="s1">name=</span><span class="s4">&quot;name&quot;</span><span class="s1">))</span><span class="s3">,</span>
            <span class="s4">&quot;timeout after 5 seconds (pid=321, name='name')&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_process__eq__(self):</span>
        <span class="s1">p1 = psutil.Process()</span>
        <span class="s1">p2 = psutil.Process()</span>
        <span class="s1">self.assertEqual(p1</span><span class="s3">, </span><span class="s1">p2)</span>
        <span class="s1">p2._ident = (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">self.assertNotEqual(p1</span><span class="s3">, </span><span class="s1">p2)</span>
        <span class="s1">self.assertNotEqual(p1</span><span class="s3">, </span><span class="s4">'foo'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_process__hash__(self):</span>
        <span class="s1">s = set([psutil.Process()</span><span class="s3">, </span><span class="s1">psutil.Process()])</span>
        <span class="s1">self.assertEqual(len(s)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>


<span class="s0"># ===================================================================</span>
<span class="s0"># --- Misc, generic, corner cases</span>
<span class="s0"># ===================================================================</span>


<span class="s3">class </span><span class="s1">TestMisc(PsutilTestCase):</span>

    <span class="s3">def </span><span class="s1">test__all__(self):</span>
        <span class="s1">dir_psutil = dir(psutil)</span>
        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">dir_psutil:</span>
            <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">(</span><span class="s4">'long'</span><span class="s3">, </span><span class="s4">'tests'</span><span class="s3">, </span><span class="s4">'test'</span><span class="s3">, </span><span class="s4">'PermissionError'</span><span class="s3">,</span>
                        <span class="s4">'ProcessLookupError'</span><span class="s1">):</span>
                <span class="s3">continue</span>
            <span class="s3">if not </span><span class="s1">name.startswith(</span><span class="s4">'_'</span><span class="s1">):</span>
                <span class="s3">try</span><span class="s1">:</span>
                    <span class="s1">__import__(name)</span>
                <span class="s3">except </span><span class="s1">ImportError:</span>
                    <span class="s3">if </span><span class="s1">name </span><span class="s3">not in </span><span class="s1">psutil.__all__:</span>
                        <span class="s1">fun = getattr(psutil</span><span class="s3">, </span><span class="s1">name)</span>
                        <span class="s3">if </span><span class="s1">fun </span><span class="s3">is None</span><span class="s1">:</span>
                            <span class="s3">continue</span>
                        <span class="s3">if </span><span class="s1">(fun.__doc__ </span><span class="s3">is not None and</span>
                                <span class="s4">'deprecated' </span><span class="s3">not in </span><span class="s1">fun.__doc__.lower()):</span>
                            <span class="s3">raise </span><span class="s1">self.fail(</span><span class="s4">'%r not in psutil.__all__' </span><span class="s1">% name)</span>

        <span class="s0"># Import 'star' will break if __all__ is inconsistent, see:</span>
        <span class="s0"># https://github.com/giampaolo/psutil/issues/656</span>
        <span class="s0"># Can't do `from psutil import *` as it won't work on python 3</span>
        <span class="s0"># so we simply iterate over __all__.</span>
        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">psutil.__all__:</span>
            <span class="s1">self.assertIn(name</span><span class="s3">, </span><span class="s1">dir_psutil)</span>

    <span class="s3">def </span><span class="s1">test_version(self):</span>
        <span class="s1">self.assertEqual(</span><span class="s4">'.'</span><span class="s1">.join([str(x) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">psutil.version_info])</span><span class="s3">,</span>
                         <span class="s1">psutil.__version__)</span>

    <span class="s3">def </span><span class="s1">test_process_as_dict_no_new_names(self):</span>
        <span class="s0"># See https://github.com/giampaolo/psutil/issues/813</span>
        <span class="s1">p = psutil.Process()</span>
        <span class="s1">p.foo = </span><span class="s4">'1'</span>
        <span class="s1">self.assertNotIn(</span><span class="s4">'foo'</span><span class="s3">, </span><span class="s1">p.as_dict())</span>

    <span class="s3">def </span><span class="s1">test_serialization(self):</span>
        <span class="s3">def </span><span class="s1">check(ret):</span>
            <span class="s3">if </span><span class="s1">json </span><span class="s3">is not None</span><span class="s1">:</span>
                <span class="s1">json.loads(json.dumps(ret))</span>
            <span class="s1">a = pickle.dumps(ret)</span>
            <span class="s1">b = pickle.loads(a)</span>
            <span class="s1">self.assertEqual(ret</span><span class="s3">, </span><span class="s1">b)</span>

        <span class="s1">check(psutil.Process().as_dict())</span>
        <span class="s1">check(psutil.virtual_memory())</span>
        <span class="s1">check(psutil.swap_memory())</span>
        <span class="s1">check(psutil.cpu_times())</span>
        <span class="s1">check(psutil.cpu_times_percent(interval=</span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">check(psutil.net_io_counters())</span>
        <span class="s3">if </span><span class="s1">LINUX </span><span class="s3">and not </span><span class="s1">os.path.exists(</span><span class="s4">'/proc/diskstats'</span><span class="s1">):</span>
            <span class="s3">pass</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">if not </span><span class="s1">APPVEYOR:</span>
                <span class="s1">check(psutil.disk_io_counters())</span>
        <span class="s1">check(psutil.disk_partitions())</span>
        <span class="s1">check(psutil.disk_usage(os.getcwd()))</span>
        <span class="s1">check(psutil.users())</span>

    <span class="s0"># XXX: https://github.com/pypa/setuptools/pull/2896</span>
    <span class="s1">@unittest.skipIf(APPVEYOR</span><span class="s3">, </span><span class="s4">&quot;temporarily disabled due to setuptools bug&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_setup_script(self):</span>
        <span class="s1">setup_py = os.path.join(ROOT_DIR</span><span class="s3">, </span><span class="s4">'setup.py'</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">CI_TESTING </span><span class="s3">and not </span><span class="s1">os.path.exists(setup_py):</span>
            <span class="s3">return </span><span class="s1">self.skipTest(</span><span class="s4">&quot;can't find setup.py&quot;</span><span class="s1">)</span>
        <span class="s1">module = import_module_by_path(setup_py)</span>
        <span class="s1">self.assertRaises(SystemExit</span><span class="s3">, </span><span class="s1">module.setup)</span>
        <span class="s1">self.assertEqual(module.get_version()</span><span class="s3">, </span><span class="s1">psutil.__version__)</span>

    <span class="s3">def </span><span class="s1">test_ad_on_process_creation(self):</span>
        <span class="s0"># We are supposed to be able to instantiate Process also in case</span>
        <span class="s0"># of zombie processes or access denied.</span>
        <span class="s3">with </span><span class="s1">mock.patch.object(psutil.Process</span><span class="s3">, </span><span class="s4">'create_time'</span><span class="s3">,</span>
                               <span class="s1">side_effect=psutil.AccessDenied) </span><span class="s3">as </span><span class="s1">meth:</span>
            <span class="s1">psutil.Process()</span>
            <span class="s3">assert </span><span class="s1">meth.called</span>
        <span class="s3">with </span><span class="s1">mock.patch.object(psutil.Process</span><span class="s3">, </span><span class="s4">'create_time'</span><span class="s3">,</span>
                               <span class="s1">side_effect=psutil.ZombieProcess(</span><span class="s5">1</span><span class="s1">)) </span><span class="s3">as </span><span class="s1">meth:</span>
            <span class="s1">psutil.Process()</span>
            <span class="s3">assert </span><span class="s1">meth.called</span>
        <span class="s3">with </span><span class="s1">mock.patch.object(psutil.Process</span><span class="s3">, </span><span class="s4">'create_time'</span><span class="s3">,</span>
                               <span class="s1">side_effect=ValueError) </span><span class="s3">as </span><span class="s1">meth:</span>
            <span class="s3">with </span><span class="s1">self.assertRaises(ValueError):</span>
                <span class="s1">psutil.Process()</span>
            <span class="s3">assert </span><span class="s1">meth.called</span>

    <span class="s3">def </span><span class="s1">test_sanity_version_check(self):</span>
        <span class="s0"># see: https://github.com/giampaolo/psutil/issues/564</span>
        <span class="s3">with </span><span class="s1">mock.patch(</span>
                <span class="s4">&quot;psutil._psplatform.cext.version&quot;</span><span class="s3">, </span><span class="s1">return_value=</span><span class="s4">&quot;0.0.0&quot;</span><span class="s1">):</span>
            <span class="s3">with </span><span class="s1">self.assertRaises(ImportError) </span><span class="s3">as </span><span class="s1">cm:</span>
                <span class="s1">reload_module(psutil)</span>
            <span class="s1">self.assertIn(</span><span class="s4">&quot;version conflict&quot;</span><span class="s3">, </span><span class="s1">str(cm.exception).lower())</span>


<span class="s0"># ===================================================================</span>
<span class="s0"># --- psutil/_common.py utils</span>
<span class="s0"># ===================================================================</span>


<span class="s3">class </span><span class="s1">TestCommonModule(PsutilTestCase):</span>

    <span class="s3">def </span><span class="s1">test_memoize(self):</span>
        <span class="s1">@memoize</span>
        <span class="s3">def </span><span class="s1">foo(*args</span><span class="s3">, </span><span class="s1">**kwargs):</span>
            <span class="s2">&quot;&quot;&quot;foo docstring&quot;&quot;&quot;</span>
            <span class="s1">calls.append(</span><span class="s3">None</span><span class="s1">)</span>
            <span class="s3">return </span><span class="s1">(args</span><span class="s3">, </span><span class="s1">kwargs)</span>

        <span class="s1">calls = []</span>
        <span class="s0"># no args</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
            <span class="s1">ret = foo()</span>
            <span class="s1">expected = (()</span><span class="s3">, </span><span class="s1">{})</span>
            <span class="s1">self.assertEqual(ret</span><span class="s3">, </span><span class="s1">expected)</span>
            <span class="s1">self.assertEqual(len(calls)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s0"># with args</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
            <span class="s1">ret = foo(</span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">expected = ((</span><span class="s5">1</span><span class="s3">, </span><span class="s1">)</span><span class="s3">, </span><span class="s1">{})</span>
            <span class="s1">self.assertEqual(ret</span><span class="s3">, </span><span class="s1">expected)</span>
            <span class="s1">self.assertEqual(len(calls)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s0"># with args + kwargs</span>
        <span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
            <span class="s1">ret = foo(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">bar=</span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">expected = ((</span><span class="s5">1</span><span class="s3">, </span><span class="s1">)</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'bar'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">})</span>
            <span class="s1">self.assertEqual(ret</span><span class="s3">, </span><span class="s1">expected)</span>
            <span class="s1">self.assertEqual(len(calls)</span><span class="s3">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s0"># clear cache</span>
        <span class="s1">foo.cache_clear()</span>
        <span class="s1">ret = foo()</span>
        <span class="s1">expected = (()</span><span class="s3">, </span><span class="s1">{})</span>
        <span class="s1">self.assertEqual(ret</span><span class="s3">, </span><span class="s1">expected)</span>
        <span class="s1">self.assertEqual(len(calls)</span><span class="s3">, </span><span class="s5">4</span><span class="s1">)</span>
        <span class="s0"># docstring</span>
        <span class="s1">self.assertEqual(foo.__doc__</span><span class="s3">, </span><span class="s4">&quot;foo docstring&quot;</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_memoize_when_activated(self):</span>
        <span class="s3">class </span><span class="s1">Foo:</span>

            <span class="s1">@memoize_when_activated</span>
            <span class="s3">def </span><span class="s1">foo(self):</span>
                <span class="s1">calls.append(</span><span class="s3">None</span><span class="s1">)</span>

        <span class="s1">f = Foo()</span>
        <span class="s1">calls = []</span>
        <span class="s1">f.foo()</span>
        <span class="s1">f.foo()</span>
        <span class="s1">self.assertEqual(len(calls)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>

        <span class="s0"># activate</span>
        <span class="s1">calls = []</span>
        <span class="s1">f.foo.cache_activate(f)</span>
        <span class="s1">f.foo()</span>
        <span class="s1">f.foo()</span>
        <span class="s1">self.assertEqual(len(calls)</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>

        <span class="s0"># deactivate</span>
        <span class="s1">calls = []</span>
        <span class="s1">f.foo.cache_deactivate(f)</span>
        <span class="s1">f.foo()</span>
        <span class="s1">f.foo()</span>
        <span class="s1">self.assertEqual(len(calls)</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_parse_environ_block(self):</span>
        <span class="s3">def </span><span class="s1">k(s):</span>
            <span class="s3">return </span><span class="s1">s.upper() </span><span class="s3">if </span><span class="s1">WINDOWS </span><span class="s3">else </span><span class="s1">s</span>

        <span class="s1">self.assertEqual(parse_environ_block(</span><span class="s4">&quot;a=1</span><span class="s3">\0</span><span class="s4">&quot;</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{k(</span><span class="s4">&quot;a&quot;</span><span class="s1">): </span><span class="s4">&quot;1&quot;</span><span class="s1">})</span>
        <span class="s1">self.assertEqual(parse_environ_block(</span><span class="s4">&quot;a=1</span><span class="s3">\0</span><span class="s4">b=2</span><span class="s3">\0\0</span><span class="s4">&quot;</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{k(</span><span class="s4">&quot;a&quot;</span><span class="s1">): </span><span class="s4">&quot;1&quot;</span><span class="s3">, </span><span class="s1">k(</span><span class="s4">&quot;b&quot;</span><span class="s1">): </span><span class="s4">&quot;2&quot;</span><span class="s1">})</span>
        <span class="s1">self.assertEqual(parse_environ_block(</span><span class="s4">&quot;a=1</span><span class="s3">\0</span><span class="s4">b=</span><span class="s3">\0\0</span><span class="s4">&quot;</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{k(</span><span class="s4">&quot;a&quot;</span><span class="s1">): </span><span class="s4">&quot;1&quot;</span><span class="s3">, </span><span class="s1">k(</span><span class="s4">&quot;b&quot;</span><span class="s1">): </span><span class="s4">&quot;&quot;</span><span class="s1">})</span>
        <span class="s0"># ignore everything after \0\0</span>
        <span class="s1">self.assertEqual(parse_environ_block(</span><span class="s4">&quot;a=1</span><span class="s3">\0</span><span class="s4">b=2</span><span class="s3">\0\0</span><span class="s4">c=3</span><span class="s3">\0</span><span class="s4">&quot;</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{k(</span><span class="s4">&quot;a&quot;</span><span class="s1">): </span><span class="s4">&quot;1&quot;</span><span class="s3">, </span><span class="s1">k(</span><span class="s4">&quot;b&quot;</span><span class="s1">): </span><span class="s4">&quot;2&quot;</span><span class="s1">})</span>
        <span class="s0"># ignore everything that is not an assignment</span>
        <span class="s1">self.assertEqual(parse_environ_block(</span><span class="s4">&quot;xxx</span><span class="s3">\0</span><span class="s4">a=1</span><span class="s3">\0</span><span class="s4">&quot;</span><span class="s1">)</span><span class="s3">, </span><span class="s1">{k(</span><span class="s4">&quot;a&quot;</span><span class="s1">): </span><span class="s4">&quot;1&quot;</span><span class="s1">})</span>
        <span class="s1">self.assertEqual(parse_environ_block(</span><span class="s4">&quot;a=1</span><span class="s3">\0</span><span class="s4">=b=2</span><span class="s3">\0</span><span class="s4">&quot;</span><span class="s1">)</span><span class="s3">, </span><span class="s1">{k(</span><span class="s4">&quot;a&quot;</span><span class="s1">): </span><span class="s4">&quot;1&quot;</span><span class="s1">})</span>
        <span class="s0"># do not fail if the block is incomplete</span>
        <span class="s1">self.assertEqual(parse_environ_block(</span><span class="s4">&quot;a=1</span><span class="s3">\0</span><span class="s4">b=2&quot;</span><span class="s1">)</span><span class="s3">, </span><span class="s1">{k(</span><span class="s4">&quot;a&quot;</span><span class="s1">): </span><span class="s4">&quot;1&quot;</span><span class="s1">})</span>

    <span class="s3">def </span><span class="s1">test_supports_ipv6(self):</span>
        <span class="s1">self.addCleanup(supports_ipv6.cache_clear)</span>
        <span class="s3">if </span><span class="s1">supports_ipv6():</span>
            <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.socket'</span><span class="s1">) </span><span class="s3">as </span><span class="s1">s:</span>
                <span class="s1">s.has_ipv6 = </span><span class="s3">False</span>
                <span class="s1">supports_ipv6.cache_clear()</span>
                <span class="s3">assert not </span><span class="s1">supports_ipv6()</span>

            <span class="s1">supports_ipv6.cache_clear()</span>
            <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.socket.socket'</span><span class="s3">,</span>
                            <span class="s1">side_effect=socket.error) </span><span class="s3">as </span><span class="s1">s:</span>
                <span class="s3">assert not </span><span class="s1">supports_ipv6()</span>
                <span class="s3">assert </span><span class="s1">s.called</span>

            <span class="s1">supports_ipv6.cache_clear()</span>
            <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.socket.socket'</span><span class="s3">,</span>
                            <span class="s1">side_effect=socket.gaierror) </span><span class="s3">as </span><span class="s1">s:</span>
                <span class="s3">assert not </span><span class="s1">supports_ipv6()</span>
                <span class="s1">supports_ipv6.cache_clear()</span>
                <span class="s3">assert </span><span class="s1">s.called</span>

            <span class="s1">supports_ipv6.cache_clear()</span>
            <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.socket.socket.bind'</span><span class="s3">,</span>
                            <span class="s1">side_effect=socket.gaierror) </span><span class="s3">as </span><span class="s1">s:</span>
                <span class="s3">assert not </span><span class="s1">supports_ipv6()</span>
                <span class="s1">supports_ipv6.cache_clear()</span>
                <span class="s3">assert </span><span class="s1">s.called</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">with </span><span class="s1">self.assertRaises(socket.error):</span>
                <span class="s1">sock = socket.socket(socket.AF_INET6</span><span class="s3">, </span><span class="s1">socket.SOCK_STREAM)</span>
                <span class="s3">try</span><span class="s1">:</span>
                    <span class="s1">sock.bind((</span><span class="s4">&quot;::1&quot;</span><span class="s3">, </span><span class="s5">0</span><span class="s1">))</span>
                <span class="s3">finally</span><span class="s1">:</span>
                    <span class="s1">sock.close()</span>

    <span class="s3">def </span><span class="s1">test_isfile_strict(self):</span>
        <span class="s1">this_file = os.path.abspath(__file__)</span>
        <span class="s3">assert </span><span class="s1">isfile_strict(this_file)</span>
        <span class="s3">assert not </span><span class="s1">isfile_strict(os.path.dirname(this_file))</span>
        <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.os.stat'</span><span class="s3">,</span>
                        <span class="s1">side_effect=OSError(errno.EPERM</span><span class="s3">, </span><span class="s4">&quot;foo&quot;</span><span class="s1">)):</span>
            <span class="s1">self.assertRaises(OSError</span><span class="s3">, </span><span class="s1">isfile_strict</span><span class="s3">, </span><span class="s1">this_file)</span>
        <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.os.stat'</span><span class="s3">,</span>
                        <span class="s1">side_effect=OSError(errno.EACCES</span><span class="s3">, </span><span class="s4">&quot;foo&quot;</span><span class="s1">)):</span>
            <span class="s1">self.assertRaises(OSError</span><span class="s3">, </span><span class="s1">isfile_strict</span><span class="s3">, </span><span class="s1">this_file)</span>
        <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.os.stat'</span><span class="s3">,</span>
                        <span class="s1">side_effect=OSError(errno.ENOENT</span><span class="s3">, </span><span class="s4">&quot;foo&quot;</span><span class="s1">)):</span>
            <span class="s3">assert not </span><span class="s1">isfile_strict(this_file)</span>
        <span class="s3">with </span><span class="s1">mock.patch(</span><span class="s4">'psutil._common.stat.S_ISREG'</span><span class="s3">, </span><span class="s1">return_value=</span><span class="s3">False</span><span class="s1">):</span>
            <span class="s3">assert not </span><span class="s1">isfile_strict(this_file)</span>

    <span class="s3">def </span><span class="s1">test_debug(self):</span>
        <span class="s3">if </span><span class="s1">PY3:</span>
            <span class="s3">from </span><span class="s1">io </span><span class="s3">import </span><span class="s1">StringIO</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s3">from </span><span class="s1">StringIO </span><span class="s3">import </span><span class="s1">StringIO</span>

        <span class="s3">with </span><span class="s1">redirect_stderr(StringIO()) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s1">debug(</span><span class="s4">&quot;hello&quot;</span><span class="s1">)</span>
        <span class="s1">msg = f.getvalue()</span>
        <span class="s3">assert </span><span class="s1">msg.startswith(</span><span class="s4">&quot;psutil-debug&quot;</span><span class="s1">)</span><span class="s3">, </span><span class="s1">msg</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;hello&quot;</span><span class="s3">, </span><span class="s1">msg)</span>
        <span class="s1">self.assertIn(__file__.replace(</span><span class="s4">'.pyc'</span><span class="s3">, </span><span class="s4">'.py'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">msg)</span>

        <span class="s0"># supposed to use repr(exc)</span>
        <span class="s3">with </span><span class="s1">redirect_stderr(StringIO()) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s1">debug(ValueError(</span><span class="s4">&quot;this is an error&quot;</span><span class="s1">))</span>
        <span class="s1">msg = f.getvalue()</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;ignoring ValueError&quot;</span><span class="s3">, </span><span class="s1">msg)</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;'this is an error'&quot;</span><span class="s3">, </span><span class="s1">msg)</span>

        <span class="s0"># supposed to use str(exc), because of extra info about file name</span>
        <span class="s3">with </span><span class="s1">redirect_stderr(StringIO()) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s1">exc = OSError(</span><span class="s5">2</span><span class="s3">, </span><span class="s4">&quot;no such file&quot;</span><span class="s1">)</span>
            <span class="s1">exc.filename = </span><span class="s4">&quot;/foo&quot;</span>
            <span class="s1">debug(exc)</span>
        <span class="s1">msg = f.getvalue()</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;no such file&quot;</span><span class="s3">, </span><span class="s1">msg)</span>
        <span class="s1">self.assertIn(</span><span class="s4">&quot;/foo&quot;</span><span class="s3">, </span><span class="s1">msg)</span>

    <span class="s3">def </span><span class="s1">test_cat_bcat(self):</span>
        <span class="s1">testfn = self.get_testfn()</span>
        <span class="s3">with </span><span class="s1">open(testfn</span><span class="s3">, </span><span class="s4">&quot;wt&quot;</span><span class="s1">) </span><span class="s3">as </span><span class="s1">f:</span>
            <span class="s1">f.write(</span><span class="s4">&quot;foo&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(cat(testfn)</span><span class="s3">, </span><span class="s4">&quot;foo&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(bcat(testfn)</span><span class="s3">, </span><span class="s6">b&quot;foo&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertRaises(FileNotFoundError</span><span class="s3">, </span><span class="s1">cat</span><span class="s3">, </span><span class="s1">testfn + </span><span class="s4">'-invalid'</span><span class="s1">)</span>
        <span class="s1">self.assertRaises(FileNotFoundError</span><span class="s3">, </span><span class="s1">bcat</span><span class="s3">, </span><span class="s1">testfn + </span><span class="s4">'-invalid'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(cat(testfn + </span><span class="s4">'-invalid'</span><span class="s3">, </span><span class="s1">fallback=</span><span class="s4">&quot;bar&quot;</span><span class="s1">)</span><span class="s3">, </span><span class="s4">&quot;bar&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(bcat(testfn + </span><span class="s4">'-invalid'</span><span class="s3">, </span><span class="s1">fallback=</span><span class="s4">&quot;bar&quot;</span><span class="s1">)</span><span class="s3">, </span><span class="s4">&quot;bar&quot;</span><span class="s1">)</span>


<span class="s0"># ===================================================================</span>
<span class="s0"># --- Tests for wrap_numbers() function.</span>
<span class="s0"># ===================================================================</span>


<span class="s1">nt = collections.namedtuple(</span><span class="s4">'foo'</span><span class="s3">, </span><span class="s4">'a b c'</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestWrapNumbers(PsutilTestCase):</span>

    <span class="s3">def </span><span class="s1">setUp(self):</span>
        <span class="s1">wrap_numbers.cache_clear()</span>

    <span class="s1">tearDown = setUp</span>

    <span class="s3">def </span><span class="s1">test_first_call(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>

    <span class="s3">def </span><span class="s1">test_input_hasnt_changed(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>

    <span class="s3">def </span><span class="s1">test_increase_but_no_wrap(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">25</span><span class="s3">, </span><span class="s5">30</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">25</span><span class="s3">, </span><span class="s5">30</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>

    <span class="s3">def </span><span class="s1">test_wrap(self):</span>
        <span class="s0"># let's say 100 is the threshold</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s0"># first wrap restarts from 10</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">110</span><span class="s1">)})</span>
        <span class="s0"># then it remains the same</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">110</span><span class="s1">)})</span>
        <span class="s0"># then it goes up</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">90</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">190</span><span class="s1">)})</span>
        <span class="s0"># then it wraps again</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">210</span><span class="s1">)})</span>
        <span class="s0"># and remains the same</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">210</span><span class="s1">)})</span>
        <span class="s0"># now wrap another num</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">150</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">210</span><span class="s1">)})</span>
        <span class="s0"># and again</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">40</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">190</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">210</span><span class="s1">)})</span>
        <span class="s0"># keep it the same</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">40</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">190</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">210</span><span class="s1">)})</span>

    <span class="s3">def </span><span class="s1">test_changing_keys(self):</span>
        <span class="s0"># Emulate a case where the second call to disk_io()</span>
        <span class="s0"># (or whatever) provides a new disk, then the new disk</span>
        <span class="s0"># disappears on the third call.</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)</span><span class="s3">,</span>
                 <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">8</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>

    <span class="s3">def </span><span class="s1">test_changing_keys_w_wrap(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)</span><span class="s3">,</span>
                 <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s0"># disk 2 wraps</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)</span><span class="s3">,</span>
                 <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)</span><span class="s3">,</span>
                          <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">110</span><span class="s1">)})</span>
        <span class="s0"># disk 2 disappears</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>

        <span class="s0"># then it appears again; the old wrap is supposed to be</span>
        <span class="s0"># gone.</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)</span><span class="s3">,</span>
                 <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s0"># remains the same</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)</span><span class="s3">,</span>
                 <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">input)</span>
        <span class="s0"># and then wraps again</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)</span><span class="s3">,</span>
                 <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">,</span>
                         <span class="s1">{</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">50</span><span class="s1">)</span><span class="s3">,</span>
                          <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">110</span><span class="s1">)})</span>

    <span class="s3">def </span><span class="s1">test_real_data(self):</span>
        <span class="s1">d = {</span><span class="s4">'nvme0n1'</span><span class="s1">: (</span><span class="s5">300</span><span class="s3">, </span><span class="s5">508</span><span class="s3">, </span><span class="s5">640</span><span class="s3">, </span><span class="s5">1571</span><span class="s3">, </span><span class="s5">5970</span><span class="s3">, </span><span class="s5">1987</span><span class="s3">, </span><span class="s5">2049</span><span class="s3">, </span><span class="s5">451751</span><span class="s3">, </span><span class="s5">47048</span><span class="s1">)</span><span class="s3">,</span>
             <span class="s4">'nvme0n1p1'</span><span class="s1">: (</span><span class="s5">1171</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5600256</span><span class="s3">, </span><span class="s5">1024</span><span class="s3">, </span><span class="s5">516</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">8</span><span class="s1">)</span><span class="s3">,</span>
             <span class="s4">'nvme0n1p2'</span><span class="s1">: (</span><span class="s5">54</span><span class="s3">, </span><span class="s5">54</span><span class="s3">, </span><span class="s5">2396160</span><span class="s3">, </span><span class="s5">5165056</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">24</span><span class="s3">, </span><span class="s5">30</span><span class="s3">, </span><span class="s5">1207</span><span class="s3">, </span><span class="s5">28</span><span class="s1">)</span><span class="s3">,</span>
             <span class="s4">'nvme0n1p3'</span><span class="s1">: (</span><span class="s5">2389</span><span class="s3">, </span><span class="s5">4539</span><span class="s3">, </span><span class="s5">5154</span><span class="s3">, </span><span class="s5">150</span><span class="s3">, </span><span class="s5">4828</span><span class="s3">, </span><span class="s5">1844</span><span class="s3">, </span><span class="s5">2019</span><span class="s3">, </span><span class="s5">398</span><span class="s3">, </span><span class="s5">348</span><span class="s1">)}</span>
        <span class="s1">self.assertEqual(wrap_numbers(d</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s1">self.assertEqual(wrap_numbers(d</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s0"># decrease this   ↓</span>
        <span class="s1">d = {</span><span class="s4">'nvme0n1'</span><span class="s1">: (</span><span class="s5">100</span><span class="s3">, </span><span class="s5">508</span><span class="s3">, </span><span class="s5">640</span><span class="s3">, </span><span class="s5">1571</span><span class="s3">, </span><span class="s5">5970</span><span class="s3">, </span><span class="s5">1987</span><span class="s3">, </span><span class="s5">2049</span><span class="s3">, </span><span class="s5">451751</span><span class="s3">, </span><span class="s5">47048</span><span class="s1">)</span><span class="s3">,</span>
             <span class="s4">'nvme0n1p1'</span><span class="s1">: (</span><span class="s5">1171</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5600256</span><span class="s3">, </span><span class="s5">1024</span><span class="s3">, </span><span class="s5">516</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">8</span><span class="s1">)</span><span class="s3">,</span>
             <span class="s4">'nvme0n1p2'</span><span class="s1">: (</span><span class="s5">54</span><span class="s3">, </span><span class="s5">54</span><span class="s3">, </span><span class="s5">2396160</span><span class="s3">, </span><span class="s5">5165056</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">24</span><span class="s3">, </span><span class="s5">30</span><span class="s3">, </span><span class="s5">1207</span><span class="s3">, </span><span class="s5">28</span><span class="s1">)</span><span class="s3">,</span>
             <span class="s4">'nvme0n1p3'</span><span class="s1">: (</span><span class="s5">2389</span><span class="s3">, </span><span class="s5">4539</span><span class="s3">, </span><span class="s5">5154</span><span class="s3">, </span><span class="s5">150</span><span class="s3">, </span><span class="s5">4828</span><span class="s3">, </span><span class="s5">1844</span><span class="s3">, </span><span class="s5">2019</span><span class="s3">, </span><span class="s5">398</span><span class="s3">, </span><span class="s5">348</span><span class="s1">)}</span>
        <span class="s1">out = wrap_numbers(d</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(out[</span><span class="s4">'nvme0n1'</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s5">400</span><span class="s1">)</span>

    <span class="s0"># --- cache tests</span>

    <span class="s3">def </span><span class="s1">test_cache_first_call(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">cache = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: input})</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {}})</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {}})</span>

    <span class="s3">def </span><span class="s1">test_cache_call_twice(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">cache = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: input})</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">cache[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">0</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">1</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">): </span><span class="s5">0</span><span class="s1">}})</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {}})</span>

    <span class="s3">def </span><span class="s1">test_cache_wrap(self):</span>
        <span class="s0"># let's say 100 is the threshold</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>

        <span class="s0"># first wrap restarts from 10</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">cache = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: input})</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">cache[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">0</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">1</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">): </span><span class="s5">100</span><span class="s1">}})</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {</span><span class="s4">'disk1'</span><span class="s1">: set([(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)])}})</span>

        <span class="s3">def </span><span class="s1">assert_():</span>
            <span class="s1">cache = wrap_numbers.cache_info()</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">cache[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">,</span>
                <span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">0</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">1</span><span class="s1">): </span><span class="s5">0</span><span class="s3">,</span>
                             <span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">): </span><span class="s5">100</span><span class="s1">}})</span>
            <span class="s1">self.assertEqual(cache[</span><span class="s5">2</span><span class="s1">]</span><span class="s3">,</span>
                             <span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {</span><span class="s4">'disk1'</span><span class="s1">: set([(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)])}})</span>

        <span class="s0"># then it remains the same</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">cache = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: input})</span>
        <span class="s1">assert_()</span>

        <span class="s0"># then it goes up</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">90</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">cache = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: input})</span>
        <span class="s1">assert_()</span>

        <span class="s0"># then it wraps again</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">cache = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: input})</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">cache[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">0</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">1</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">): </span><span class="s5">190</span><span class="s1">}})</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {</span><span class="s4">'disk1'</span><span class="s1">: set([(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">)])}})</span>

    <span class="s3">def </span><span class="s1">test_cache_changing_keys(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)</span><span class="s3">,</span>
                 <span class="s4">'disk2'</span><span class="s1">: nt(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">cache = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: input})</span>
        <span class="s1">self.assertEqual(</span>
            <span class="s1">cache[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">0</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">1</span><span class="s1">): </span><span class="s5">0</span><span class="s3">, </span><span class="s1">(</span><span class="s4">'disk1'</span><span class="s3">, </span><span class="s5">2</span><span class="s1">): </span><span class="s5">0</span><span class="s1">}})</span>
        <span class="s1">self.assertEqual(cache[</span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">{</span><span class="s4">'disk_io'</span><span class="s1">: {}})</span>

    <span class="s3">def </span><span class="s1">test_cache_clear(self):</span>
        <span class="s1">input = {</span><span class="s4">'disk1'</span><span class="s1">: nt(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)}</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">wrap_numbers(input</span><span class="s3">, </span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">wrap_numbers.cache_clear(</span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(wrap_numbers.cache_info()</span><span class="s3">, </span><span class="s1">({}</span><span class="s3">, </span><span class="s1">{}</span><span class="s3">, </span><span class="s1">{}))</span>
        <span class="s1">wrap_numbers.cache_clear(</span><span class="s4">'disk_io'</span><span class="s1">)</span>
        <span class="s1">wrap_numbers.cache_clear(</span><span class="s4">'?!?'</span><span class="s1">)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_NET_IO_COUNTERS</span><span class="s3">, </span><span class="s4">'not supported'</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_cache_clear_public_apis(self):</span>
        <span class="s3">if not </span><span class="s1">psutil.disk_io_counters() </span><span class="s3">or not </span><span class="s1">psutil.net_io_counters():</span>
            <span class="s3">return </span><span class="s1">self.skipTest(</span><span class="s4">&quot;no disks or NICs available&quot;</span><span class="s1">)</span>
        <span class="s1">psutil.disk_io_counters()</span>
        <span class="s1">psutil.net_io_counters()</span>
        <span class="s1">caches = wrap_numbers.cache_info()</span>
        <span class="s3">for </span><span class="s1">cache </span><span class="s3">in </span><span class="s1">caches:</span>
            <span class="s1">self.assertIn(</span><span class="s4">'psutil.disk_io_counters'</span><span class="s3">, </span><span class="s1">cache)</span>
            <span class="s1">self.assertIn(</span><span class="s4">'psutil.net_io_counters'</span><span class="s3">, </span><span class="s1">cache)</span>

        <span class="s1">psutil.disk_io_counters.cache_clear()</span>
        <span class="s1">caches = wrap_numbers.cache_info()</span>
        <span class="s3">for </span><span class="s1">cache </span><span class="s3">in </span><span class="s1">caches:</span>
            <span class="s1">self.assertIn(</span><span class="s4">'psutil.net_io_counters'</span><span class="s3">, </span><span class="s1">cache)</span>
            <span class="s1">self.assertNotIn(</span><span class="s4">'psutil.disk_io_counters'</span><span class="s3">, </span><span class="s1">cache)</span>

        <span class="s1">psutil.net_io_counters.cache_clear()</span>
        <span class="s1">caches = wrap_numbers.cache_info()</span>
        <span class="s1">self.assertEqual(caches</span><span class="s3">, </span><span class="s1">({}</span><span class="s3">, </span><span class="s1">{}</span><span class="s3">, </span><span class="s1">{}))</span>


<span class="s0"># ===================================================================</span>
<span class="s0"># --- Example script tests</span>
<span class="s0"># ===================================================================</span>


<span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">os.path.exists(SCRIPTS_DIR)</span><span class="s3">,</span>
                 <span class="s4">&quot;can't locate scripts directory&quot;</span><span class="s1">)</span>
<span class="s3">class </span><span class="s1">TestScripts(PsutilTestCase):</span>
    <span class="s2">&quot;&quot;&quot;Tests for scripts in the &quot;scripts&quot; directory.&quot;&quot;&quot;</span>

    <span class="s1">@staticmethod</span>
    <span class="s3">def </span><span class="s1">assert_stdout(exe</span><span class="s3">, </span><span class="s1">*args</span><span class="s3">, </span><span class="s1">**kwargs):</span>
        <span class="s1">exe = </span><span class="s4">'%s' </span><span class="s1">% os.path.join(SCRIPTS_DIR</span><span class="s3">, </span><span class="s1">exe)</span>
        <span class="s1">cmd = [PYTHON_EXE</span><span class="s3">, </span><span class="s1">exe]</span>
        <span class="s3">for </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">args:</span>
            <span class="s1">cmd.append(arg)</span>
        <span class="s3">try</span><span class="s1">:</span>
            <span class="s1">out = sh(cmd</span><span class="s3">, </span><span class="s1">**kwargs).strip()</span>
        <span class="s3">except </span><span class="s1">RuntimeError </span><span class="s3">as </span><span class="s1">err:</span>
            <span class="s3">if </span><span class="s4">'AccessDenied' </span><span class="s3">in </span><span class="s1">str(err):</span>
                <span class="s3">return </span><span class="s1">str(err)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s3">raise</span>
        <span class="s3">assert </span><span class="s1">out</span><span class="s3">, </span><span class="s1">out</span>
        <span class="s3">return </span><span class="s1">out</span>

    <span class="s1">@staticmethod</span>
    <span class="s3">def </span><span class="s1">assert_syntax(exe</span><span class="s3">, </span><span class="s1">args=</span><span class="s3">None</span><span class="s1">):</span>
        <span class="s1">exe = os.path.join(SCRIPTS_DIR</span><span class="s3">, </span><span class="s1">exe)</span>
        <span class="s3">if </span><span class="s1">PY3:</span>
            <span class="s1">f = open(exe</span><span class="s3">, </span><span class="s4">'rt'</span><span class="s3">, </span><span class="s1">encoding=</span><span class="s4">'utf8'</span><span class="s1">)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">f = open(exe</span><span class="s3">, </span><span class="s4">'rt'</span><span class="s1">)</span>
        <span class="s3">with </span><span class="s1">f:</span>
            <span class="s1">src = f.read()</span>
        <span class="s1">ast.parse(src)</span>

    <span class="s3">def </span><span class="s1">test_coverage(self):</span>
        <span class="s0"># make sure all example scripts have a test method defined</span>
        <span class="s1">meths = dir(self)</span>
        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">os.listdir(SCRIPTS_DIR):</span>
            <span class="s3">if </span><span class="s1">name.endswith(</span><span class="s4">'.py'</span><span class="s1">):</span>
                <span class="s3">if </span><span class="s4">'test_' </span><span class="s1">+ os.path.splitext(name)[</span><span class="s5">0</span><span class="s1">] </span><span class="s3">not in </span><span class="s1">meths:</span>
                    <span class="s0"># self.assert_stdout(name)</span>
                    <span class="s3">raise </span><span class="s1">self.fail(</span><span class="s4">'no test defined for %r script'</span>
                                    <span class="s1">% os.path.join(SCRIPTS_DIR</span><span class="s3">, </span><span class="s1">name))</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">POSIX</span><span class="s3">, </span><span class="s4">&quot;POSIX only&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_executable(self):</span>
        <span class="s3">for </span><span class="s1">root</span><span class="s3">, </span><span class="s1">dirs</span><span class="s3">, </span><span class="s1">files </span><span class="s3">in </span><span class="s1">os.walk(SCRIPTS_DIR):</span>
            <span class="s3">for </span><span class="s1">file </span><span class="s3">in </span><span class="s1">files:</span>
                <span class="s3">if </span><span class="s1">file.endswith(</span><span class="s4">'.py'</span><span class="s1">):</span>
                    <span class="s1">path = os.path.join(root</span><span class="s3">, </span><span class="s1">file)</span>
                    <span class="s3">if not </span><span class="s1">stat.S_IXUSR &amp; os.stat(path)[stat.ST_MODE]:</span>
                        <span class="s3">raise </span><span class="s1">self.fail(</span><span class="s4">'%r is not executable' </span><span class="s1">% path)</span>

    <span class="s3">def </span><span class="s1">test_disk_usage(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'disk_usage.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_free(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'free.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_meminfo(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'meminfo.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_procinfo(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'procinfo.py'</span><span class="s3">, </span><span class="s1">str(os.getpid()))</span>

    <span class="s1">@unittest.skipIf(CI_TESTING </span><span class="s3">and not </span><span class="s1">psutil.users()</span><span class="s3">, </span><span class="s4">&quot;no users&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_who(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'who.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_ps(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'ps.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_pstree(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'pstree.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_netstat(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'netstat.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_ifconfig(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'ifconfig.py'</span><span class="s1">)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_MEMORY_MAPS</span><span class="s3">, </span><span class="s4">&quot;not supported&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_pmap(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'pmap.py'</span><span class="s3">, </span><span class="s1">str(os.getpid()))</span>

    <span class="s3">def </span><span class="s1">test_procsmem(self):</span>
        <span class="s3">if </span><span class="s4">'uss' </span><span class="s3">not in </span><span class="s1">psutil.Process().memory_full_info()._fields:</span>
            <span class="s3">raise </span><span class="s1">self.skipTest(</span><span class="s4">&quot;not supported&quot;</span><span class="s1">)</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'procsmem.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_killall(self):</span>
        <span class="s1">self.assert_syntax(</span><span class="s4">'killall.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_nettop(self):</span>
        <span class="s1">self.assert_syntax(</span><span class="s4">'nettop.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_top(self):</span>
        <span class="s1">self.assert_syntax(</span><span class="s4">'top.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_iotop(self):</span>
        <span class="s1">self.assert_syntax(</span><span class="s4">'iotop.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_pidof(self):</span>
        <span class="s1">output = self.assert_stdout(</span><span class="s4">'pidof.py'</span><span class="s3">, </span><span class="s1">psutil.Process().name())</span>
        <span class="s1">self.assertIn(str(os.getpid())</span><span class="s3">, </span><span class="s1">output)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">WINDOWS</span><span class="s3">, </span><span class="s4">&quot;WINDOWS only&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_winservices(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'winservices.py'</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_cpu_distribution(self):</span>
        <span class="s1">self.assert_syntax(</span><span class="s4">'cpu_distribution.py'</span><span class="s1">)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_SENSORS_TEMPERATURES</span><span class="s3">, </span><span class="s4">&quot;not supported&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_temperatures(self):</span>
        <span class="s3">if not </span><span class="s1">psutil.sensors_temperatures():</span>
            <span class="s1">self.skipTest(</span><span class="s4">&quot;no temperatures&quot;</span><span class="s1">)</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'temperatures.py'</span><span class="s1">)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_SENSORS_FANS</span><span class="s3">, </span><span class="s4">&quot;not supported&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_fans(self):</span>
        <span class="s3">if not </span><span class="s1">psutil.sensors_fans():</span>
            <span class="s1">self.skipTest(</span><span class="s4">&quot;no fans&quot;</span><span class="s1">)</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'fans.py'</span><span class="s1">)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_SENSORS_BATTERY</span><span class="s3">, </span><span class="s4">&quot;not supported&quot;</span><span class="s1">)</span>
    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_BATTERY</span><span class="s3">, </span><span class="s4">&quot;no battery&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_battery(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'battery.py'</span><span class="s1">)</span>

    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_SENSORS_BATTERY</span><span class="s3">, </span><span class="s4">&quot;not supported&quot;</span><span class="s1">)</span>
    <span class="s1">@unittest.skipIf(</span><span class="s3">not </span><span class="s1">HAS_BATTERY</span><span class="s3">, </span><span class="s4">&quot;no battery&quot;</span><span class="s1">)</span>
    <span class="s3">def </span><span class="s1">test_sensors(self):</span>
        <span class="s1">self.assert_stdout(</span><span class="s4">'sensors.py'</span><span class="s1">)</span>


<span class="s3">if </span><span class="s1">__name__ == </span><span class="s4">'__main__'</span><span class="s1">:</span>
    <span class="s3">from </span><span class="s1">psutil.tests.runner </span><span class="s3">import </span><span class="s1">run_from_name</span>
    <span class="s1">run_from_name(__file__)</span>
</pre>
</body>
</html>